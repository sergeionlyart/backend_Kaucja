# Dev workflow (local + remote)

Этот документ фиксирует правила разработки так, чтобы несколько Codex-агентов (и людей) могли работать параллельно без конфликтов.

## 1) Branching model
**Цель:** `main` всегда зелёная и воспроизводимая.

- `main` — стабильная ветка, только через PR.
- Рабочие ветки:
  - `feature/<area>-<short>` (новая функциональность)
  - `fix/<area>-<short>` (багфикс)
  - `chore/<area>-<short>` (рефакторинг, инфраструктура, зависимости)
  - `docs/<area>-<short>` (документация)

**Area** (рекомендуемые): `ui`, `ocr`, `llm`, `pipeline`, `storage`, `prompts`, `config`, `tests`, `docs`.

## 2) Commit style
Используем **Conventional Commits**:

- `feat(ui): ...`
- `fix(storage): ...`
- `refactor(pipeline): ...`
- `test(llm): ...`
- `docs(codex): ...`
- `chore(ci): ...`

Правила:
- 1 коммит = 1 логическая единица изменения.
- В тексте коммита — *что* и *почему*, без «сделал»/«поправил».
- Не коммитить секреты/ключи/сырые документы.

## 3) Pull Request rules
PR должен быть маленьким и проверяемым.

**В PR обязательно:**
- Summary: что меняем и зачем.
- Scope: что *не* входит.
- How to test: команды/сценарии.
- Risk: потенциальные регрессии.

**Merge policy:**
- Предпочтительно **Squash merge** (чистая история) или **Rebase merge** (если важна история коммитов).
- Запрещены прямые пуши в `main`.

## 4) Параллельная работа нескольких агентов
### 4.1 Главный принцип
**Один агент = одна ветка (и желательно один worktree).**

Рекомендуемый подход:
1) Orchestrator разбивает задачу по модулям (UI/OCR/LLM/Storage/Pipeline).
2) Каждый агент работает в своём модуле и не трогает чужие файлы без необходимости.
3) Общие файлы (конфиги, общие типы, схемы) меняются только через заранее согласованный PR.

### 4.2 Git worktrees (лучший способ избежать конфликтов)
Используйте worktrees, чтобы держать несколько изолированных рабочих копий репозитория:

```bash
# из корня репо
git fetch origin

git worktree add ../wt/feature-ocr -b feature/ocr-mistral origin/main
cd ../wt/feature-ocr

# работа...
```

Правила:
- Не держать один и тот же branch одновременно в двух worktree.
- После мержа — удалять worktree:

```bash
git worktree remove ../wt/feature-ocr
```

### 4.3 Как минимизировать merge-конфликты
- PR ≤ ~400 строк diff (если не инфраструктура).
- Не смешивать рефакторинг и фичу.
- Не трогать форматирование всего проекта «заодно».
- Регулярно ребейзиться на `origin/main`:

```bash
git fetch origin
git rebase origin/main
```

## 5) Обязательные проверки перед merge
Минимальный набор quality gates:

1) **Форматирование и линт**
```bash
ruff format .
ruff check .
```

2) **Тесты**
```bash
pytest -q
```

3) **Инварианты проекта (по зоне изменений)**
- Pipeline: сохранение артефактов, идемпотентность `run_id`.
- LLM: strict structured outputs + schema validation.
- Storage: транзакционность SQLite + корректные статусы.

Если какой-то чек невозможен локально (нет ключей API, нет OCR) — в PR явно указать «не проверено» и добавить план проверки.

## 6) Remote / CI
Рекомендуется добавить CI, который запускает пункты из раздела 5.

Минимум:
- `ruff format --check`
- `ruff check`
- `pytest`

Опционально:
- `mypy` (если решите включить)
- smoke-test импорта (`python -m app.ui.gradio_app --help` или аналог)

